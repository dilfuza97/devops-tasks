{
    "builders": [
      {
        "type": "googlecompute",
        "project_id": "packer-and-g-213-ecc33178",
        "account_file": "account.json",
        "source_image_family": "centos-7",
        "zone": "us-central1-f",
        "ssh_username": "ansible",
        "image_name": "springbootapp",
        "disk_size": 30,
        "image_description": "spring boot application image",
        "image_labels": {
            "role": "web",
            "team": "devops"
        }
    }
],
"provisioners": [
    {
        "type": "shell",
        "inline": [
            "sudo yum install -y python3 && sudo yum -y install ansible && sleep 3 && ansible --version"
        ]
    },
    {
        "type": "ansible-local",
        "command": "ansible-playbook",
        "playbook_file": "playbook.yml"
    }
]
}



packer {
  required_plugins {
    googlecompute = {
      version = ">= 1.0.0"
      source  = "github.com/hashicorp/googlecompute"
    }
  }
}

source "googlecompute" "ubuntu2004" {
  image_name              = "${var.image_prefix}-${local.timestamp}"
  machine_type            = "e2-small"
  source_image            = "ubuntu-pro-2004-focal-v20220627a"
  ssh_username            = "packer"
  temporary_key_pair_type = "rsa"
  temporary_key_pair_bits = 2048
  zone                    = var.zone
  project_id              = var.project_id
}

build {
  sources = ["source.googlecompute.ubuntu2004"]
  provisioner "shell" {
    inline = [
      "echo Hello From ${source.type} ${source.name}"
    ]
  }

  provisioner "mondoo" {
    score_threshold = 80
    on_failure = "continue"
    asset_name = "${var.image_prefix}-${local.timestamp}"

    annotations = {
      Name          = "${var.image_prefix}-${local.timestamp}"
    }
  }
}